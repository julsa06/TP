import java.awt.FlowLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.FileNotFoundException;
import java.text.NumberFormat;
import java.util.Locale;
import java.util.Scanner;
import java.util.Vector;

import javax.swing.Box;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JTextField;

public class Converter extends JFrame {

	private final int CountRow = 5; // количество строк
	private Vector<Currency> data; // массив валют с курсом
	private String dataFile = "data.in"; // имя файла с данными
	private RowPanel[] rowPanels; // массив панелей строк
	private final Currency empty = new Currency("", "нет валюты", 0);

	public Converter() {
		super("Конвертер валют");

		try {
			data = parseData(new File(dataFile));
		} catch (FileNotFoundException e) {
			e.printStackTrace();
			JOptionPane.showMessageDialog(null, "Файл с данными не найден",
					"Ошибка", JOptionPane.ERROR_MESSAGE);
			System.exit(-1);
		}
		data.add(0, empty);

		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		Box box = Box.createVerticalBox();
		rowPanels = new RowPanel[CountRow];

		for (int i = 0; i < CountRow; i++) {
			rowPanels[i] = new RowPanel();
			box.add(rowPanels[i]);
		}

		setContentPane(box);
		pack();
		setResizable(false);
		setVisible(true);
	}

	private Vector<Currency> parseData(File file) throws FileNotFoundException {
		Scanner scan = new Scanner(file);
		Vector<Currency> data = new Vector<Currency>();

		while (scan.hasNext()) {
			String key = scan.next();
			String rateString = scan.next();
			String name = scan.nextLine();

			try {
				double rate = Double.parseDouble(rateString);
				data.add(new Currency(key, name, rate));
			} catch (NumberFormatException e) {
				JOptionPane.showMessageDialog(null, "Некорректные данные",
						"Ошибка", JOptionPane.ERROR_MESSAGE);
				System.exit(-1);
			}
		}
		return data;
	}

	private class RowPanel extends JPanel {
		private JComboBox<Currency> comboBox; // список валют
		private Field text; // ввод данных
		private JButton button; // кнопка пересчета

		RowPanel() {
			comboBox = new JComboBox<Currency>(data);
			button = new JButton("Пересчитать");
			button.addActionListener(new Recalculate(this));
			text = new Field();

			setLayout(new FlowLayout());
			add(comboBox);
			add(text);
			add(button);
		}

		Currency getCurrency() {
			return (Currency) comboBox.getSelectedItem();
		}

		Field getField() {
			return text;
		}

		class Field extends JTextField {
			Field() {
				super(6);
			}

			public double get() {
				return Double.parseDouble(getText());
			}
		}

	}

	private class Recalculate implements ActionListener {
		private RowPanel panel;
		private NumberFormat nf;

		Recalculate(RowPanel panel) {
			this.panel = panel;
			nf = NumberFormat.getInstance(Locale.US);
			nf.setMaximumFractionDigits(2);
			nf.setGroupingUsed(false);
		}

		@Override
		public void actionPerformed(ActionEvent e) {
			if ((panel.getCurrency() == empty)
					|| (panel.getField().getText().equals(""))) {
				clear();
				return;
			}
			try {
				double rub = panel.getField().get()
						* panel.getCurrency().getRate();
				for (RowPanel rowPanel : rowPanels) {
					if (rowPanel != panel) {
						rowPanel.getField().setText(
								nf.format(rub
										/ rowPanel.getCurrency().getRate()));
					}
				}
			} catch (NumberFormatException ex) {
				JOptionPane.showMessageDialog(null,
						"Некорректный ввод: не является числом.", "Ошибка",
						JOptionPane.ERROR_MESSAGE);
			}
		}
	}

	private void clear() {
		for (RowPanel rowPanel : rowPanels) {
			rowPanel.getField().setText("");
		}
	}

	private class Currency {
		private String key;
		private String name;
		private double rate;

		Currency(String key, String name, double rate) {
			this.key = key;
			this.name = name;
			this.rate = rate;
		}

		@Override
		public String toString() {
			return key + "(" + name + ")";
		}

		public double getRate() {
			return rate;
		}
	}
}
